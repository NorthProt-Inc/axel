#!/bin/bash
# tools/axel-ops — Human→Coordinator CLI
# 지시:  ax "빌드 고쳐"          (P1 기본)
#        ax -0 "긴급 수정"       (P0)
#        ax -2 "나중에 해"       (P2)
#        ax -f "색상 별로"       (feedback)
# 관리:  ax halt UI-002 / ax approve UI-002
# 조회:  ax s / ax b / ax e / ax log
set -euo pipefail

SCRIPT="$(readlink -f "$0")"
OPS="$(cd "$(dirname "$SCRIPT")/.." && pwd)/.axel-ops"
HD="$OPS/comms/human.md"

say() {
	local line="- [ ] **[$1]** $2"
	echo "$line" >> "$HD"
	echo "  $line"
}

# No args = help
[ $# -eq 0 ] && set -- help

case "$1" in
	-0)  shift; say "P0 directive" "${*:?메시지를 입력하세요}" ;;
	-2)  shift; say "P2 directive" "${*:?메시지를 입력하세요}" ;;
	-3)  shift; say "P3 directive" "${*:?메시지를 입력하세요}" ;;
	-f)  shift; say "P2 feedback" "${*:?메시지를 입력하세요}" ;;
	halt)
		shift; say "P0 halt" "Halt task ${1:?TASK-ID 필요}" ;;
	approve)
		shift; say "P1 approve" "Approve ${1:?TASK-ID 필요}" ;;
	s|status)   [ -f "$OPS/PROGRESS.md" ] && cat "$OPS/PROGRESS.md" || echo "없음" ;;
	b|backlog)  [ -f "$OPS/BACKLOG.md" ] && cat "$OPS/BACKLOG.md" || echo "없음" ;;
	e|errors)   [ -f "$OPS/ERRORS.md" ] && cat "$OPS/ERRORS.md" || echo "없음" ;;
	log)        [ -f "$OPS/logs/cycle.log" ] && tail -20 "$OPS/logs/cycle.log" || echo "없음" ;;
	pending)    grep -n '^\- \[ \]' "$HD" 2>/dev/null || echo "대기 중인 지시 없음" ;;
	clear)      sed -i '/^\- \[x\]/d' "$HD" && echo "처리 완료된 항목 삭제" ;;
	help|-h)
		cat <<'HELP'
ax — Axel 지시 CLI

  ax "메시지"              P1 지시 (기본)
  ax -0 "메시지"           P0 긴급 지시
  ax -2 "메시지"           P2 지시
  ax -f "메시지"           피드백

  ax halt TASK-ID          작업 중단
  ax approve TASK-ID       승인

  ax s                     상태 (PROGRESS)
  ax b                     백로그 (BACKLOG)
  ax e                     에러 (ERRORS)
  ax log                   최근 사이클 로그
  ax pending               미처리 지시 목록
  ax clear                 처리완료([x]) 항목 삭제
HELP
		;;
	*)   say "P1 directive" "$*" ;;
esac
