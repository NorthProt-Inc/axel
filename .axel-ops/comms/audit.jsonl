{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-001","location":"docs/plan/axel-project-plan.md:594","current":"embeddingDimension: z.number().int().default(768)","expected":"embeddingDimension: z.number().int().default(3072)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43 — Mark confirms full 3072d, NOT truncated 768d"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-002","location":"docs/plan/axel-project-plan.md:770","current":"embedding vector(768) NOT NULL -- pgvector: 768d (Gemini embedding-001)","expected":"embedding vector(3072) NOT NULL -- pgvector: 3072d (Gemini embedding-001)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-003","location":"docs/plan/axel-project-plan.md:978-979","current":"axnmihn: ChromaDB (별도 프로세스), 768d / Axel: pgvector (같은 DB), 768d","expected":"Axel line should read 3072d (axnmihn historical reference 768d is correct)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-004","location":"docs/plan/axel-project-plan.md:1705","current":"ChromaDB (1000+ vectors, 768d) → pgvector (re-embed or direct copy)","expected":"pgvector target should specify 3072d","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-005","location":"docs/plan/axel-project-plan.md:1715","current":"결정: Re-embed (gemini-embedding-001, 768d)","expected":"결정: Re-embed (gemini-embedding-001, 3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-006","location":"docs/plan/axel-project-plan.md:1721","current":"768d 차원 유지 → pgvector 컬럼 타입 변경 불필요","expected":"3072d로 변경 — pgvector 컬럼 타입 vector(3072)으로 변경 필요","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-007","location":"docs/plan/axel-project-plan.md:2023","current":"ADR-016 | Embedding Model: gemini-embedding-001 (768d)","expected":"ADR-016 | Embedding Model: gemini-embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-008","location":"docs/plan/axel-project-plan.md:2038","current":"gemini-embedding-001 (768d) — ADR-016","expected":"gemini-embedding-001 (3072d) — ADR-016","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-009","location":"docs/plan/axel-project-plan.md:301","current":"readonly dimension: number; // e.g., 768","expected":"readonly dimension: number; // e.g., 3072","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-010","location":"docs/adr/016-embedding-model-selection.md:20","current":"gemini-embedding-001 (768d, Matryoshka truncation) 사용","expected":"gemini-embedding-001 (3072d, full dimension) 사용. Mark의 결정으로 truncation 사용하지 않음.","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-011","location":"docs/adr/016-embedding-model-selection.md:36-48","current":"Dimension Choice: 768d 섹션 전체 (768d 선택 근거 4개)","expected":"Dimension Choice: 3072d로 변경. 근거: Mark의 결정 — full precision 우선, 저장 공간 trade-off 수용","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-012","location":"docs/adr/016-embedding-model-selection.md:65","current":"readonly dimension: 768;","expected":"readonly dimension: 3072;","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-013","location":"docs/adr/016-embedding-model-selection.md:140","current":"embeddingDimension: z.number().int().default(768)","expected":"embeddingDimension: z.number().int().default(3072)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-014","location":"docs/adr/013-six-layer-memory-architecture.md:143","current":"Gemini embedding-001 (768d)","expected":"Gemini embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-015","location":"docs/adr/002-postgresql-single-db.md:36","current":"memories + vector(768) — Semantic Memory (Layer 3, pgvector)","expected":"memories + vector(3072) — Semantic Memory (Layer 3, pgvector)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-016","location":"docs/plan/migration-strategy.md:163","current":"embedding vector(768) NOT NULL","expected":"embedding vector(3072) NOT NULL","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-017","location":"docs/plan/migration-strategy.md:463","current":"Axel uses gemini-embedding-001 (768d, PLAN-001 decision)","expected":"Axel uses gemini-embedding-001 (3072d, HUMAN DIRECTIVE override)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-018","location":"docs/plan/migration-strategy.md:474","current":"Call Gemini gemini-embedding-001 API (768d output)","expected":"Call Gemini gemini-embedding-001 API (3072d output)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-019","location":"docs/plan/v2-open-items-decisions.md:11,15","current":"Embedding Model: gemini-embedding-001 (768d) / 768d, Matryoshka truncation","expected":"gemini-embedding-001 (3072d) / 3072d, full dimension (no truncation)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-020","location":"docs/plan/v2-open-items-decisions.md:176","current":"gemini-embedding-001 (768d)","expected":"gemini-embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"HIGH","id":"AUD-021","location":"docs/adr/016-embedding-model-selection.md:28","current":"Max input tokens | 8,192","expected":"Max input tokens | 2,048","evidence":"Official Google docs: ai.google.dev/gemini-api/docs/embeddings confirms 2,048. The 8,192 figure appears to be from experimental model gemini-embedding-exp-03-07. GA model is 2,048."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"HIGH","id":"AUD-022","location":"docs/plan/migration-strategy.md:186 vs docs/plan/axel-project-plan.md:787","current":"migration-strategy uses IVFFlat (lists=100) index; plan body uses HNSW (m=16, ef_construction=64) index","expected":"Both should use HNSW as plan body Section 4 Layer 3 specifies. Migration-strategy.md migration 003 is inconsistent.","evidence":"Plan:787 says 'HNSW 권장 (RES-001: 7.4x faster queries, better recall)'. Migration SQL at migration-strategy.md:185-187 creates IVFFlat index instead."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-023","location":"docs/adr/016-embedding-model-selection.md:29","current":"Output dimensions | 3,072 (full) / 768 (truncated) / 256 (truncated)","expected":"Output dimensions | 128-3,072 (flexible). Recommended: 768 / 1,536 / 3,072","evidence":"Official Google docs: supports any integer 128-3072. Recommended values are 768, 1536, 3072. ADR omits 1536 entirely and includes non-recommended 256."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-024","location":"docs/adr/016-embedding-model-selection.md:34","current":"Task types: RETRIEVAL_DOCUMENT, RETRIEVAL_QUERY, SEMANTIC_SIMILARITY, CLASSIFICATION, CLUSTERING (5 types)","expected":"8 task types including CODE_RETRIEVAL_QUERY, QUESTION_ANSWERING, FACT_VERIFICATION","evidence":"Official Google docs: ai.google.dev/gemini-api/docs/embeddings lists 8 task types. ADR-016 missing 3."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-025","location":"docs/adr/016-embedding-model-selection.md:31","current":"MTEB score | 68.32 (#1 ranking, 2026-01 기준)","expected":"MTEB score | 68.16 (3072d GA model) or 68.32 (experimental model). Should clarify which.","evidence":"Google official docs show 768d=67.99, 3072d=68.16 for GA model. 68.32 was the experimental model score (gemini-embedding-exp-03-07)."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-026","location":"docs/research/RES-003-gemini-embedding-comparison.md:65","current":"Single input per request: Cannot batch multiple texts in one API call (batch API coming soon)","expected":"batchEmbedContents endpoint exists and was available at GA launch. Up to 250 texts per request (Vertex AI).","evidence":"Official Google API: models.batchEmbedContents endpoint documented. Vertex AI docs confirm 250 text limit per batch request."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-027","location":"docs/plan/v2-open-items-decisions.md:40-65","current":"PLAN-001 Section 2 says 'React (Vite)' for WebChat","expected":"ADR-017 superseded this to Svelte 5 (SvelteKit). PLAN-001 document not updated.","evidence":"ADR-017 status: PROPOSED. Plan main body at line 259 correctly says 'SvelteKit — ADR-017'. But PLAN-001 (v2-open-items-decisions.md) still says React."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-028","location":"docs/research/RES-003-gemini-embedding-comparison.md:29","current":"Max tokens: 2,048 input tokens","expected":"Correct (2,048). But ADR-016 says 8,192. RES-003 is correct, ADR-016 is wrong.","evidence":"Cross-reference: RES-003:29 correct vs ADR-016:28 incorrect. ADR-016 should have used RES-003 value."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-029","location":"docs/plan/axel-project-plan.md:1721-1722","current":"768d 차원 유지 → pgvector 컬럼 타입 변경 불필요 / 향후 3,072d 업그레이드 가능","expected":"3072d 변경으로 인해 이 두 줄의 논리가 뒤바뀜: 컬럼 타입 변경 필요(768→3072), 업그레이드 불필요(이미 full dim)","evidence":"HUMAN DIRECTIVE 768d→3072d 전환으로 마이그레이션 전략 논리 자체가 변경됨"}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-030","location":"docs/plan/migration-strategy.md:180-187","current":"IVFFlat index created with lists=100 for initial ~1,000 vectors. Comment says switch to HNSW at 10,000+","expected":"With 3072d vectors, IVFFlat vs HNSW trade-off changes. 3072d vectors require more memory — HNSW m=16 at 3072d = ~25KB/vector. Storage impact needs recalculation.","evidence":"RES-001 performance data was based on 1536d vectors. 3072d doubles the per-vector storage. IVFFlat lists=100 guidance was for 768d. Needs reassessment for 3072d."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-031","location":"docs/adr/016-embedding-model-selection.md:123","current":"768d로 axnmihn IVFFlat 인덱스 설정(lists=100) 재사용 가능","expected":"3072d 변경 시 이 advantage는 무효. Consequences 섹션 수정 필요.","evidence":"HUMAN DIRECTIVE 768d→3072d. axnmihn 인덱스 설정 재사용 불가."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-032","location":"docs/research/RES-003-gemini-embedding-comparison.md:135","current":"Storage (100K vectors): 1.17 GB (3072-dim) / 293 MB (768-dim)","expected":"Correct values. With 3072d decision, Axel storage for 100K vectors = ~1.17 GB. Plan cost estimates should reflect this.","evidence":"Storage calculation: 3072 × 4 bytes × 100K = ~1.17 GB. This is informational, no error in RES-003."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-033","location":"docs/adr/016-embedding-model-selection.md:68","current":"readonly rateLimitRpm: 1500; // Gemini free tier","expected":"RES-003 reports free tier RPM as 5-15 (post-Dec 2025 cuts). 1500 RPM is paid tier or pre-cut free tier.","evidence":"RES-003:75-76 says 'Free tier RPM: ~5-15 (post-Dec 2025 cuts)'. ADR-016 rateLimitRpm=1500 appears to be paid tier rate or outdated."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-034","location":"docs/research/RES-003-gemini-embedding-comparison.md:64","current":"Max tokens: 2,048 input tokens (lower than text-embedding-004's 3,000 tokens)","expected":"text-embedding-004 max tokens was 2,048, not 3,000. Multiple lines in RES-003 claim 3,000 for text-embedding-004.","evidence":"NEEDS_VERIFICATION — Google deprecated text-embedding-004 docs may no longer be available. RES-003 lines 91,99,129 claim 3,000 tokens for text-embedding-004. Some sources say 2,048. Could not conclusively verify since model is shutdown."}
{"ts":"0208T2003","from":"audit","type":"done","task":"AUDIT-001","findings_high":22,"findings_medium":8,"findings_low":4,"note":"AUDIT-001 완료. 총 34개 findings. HIGH 22건 중 20건은 768d→3072d 차원 변경(Mark 지시), 1건은 ADR-016 max input tokens 오류(8192→2048), 1건은 IVFFlat/HNSW 인덱스 불일치. MEDIUM 8건은 공식 스펙 오류(dimension options, task types, MTEB score, batch API) 및 PLAN-001 React→Svelte 미갱신. LOW 4건은 부수적 영향(인덱스 재사용, 저장공간, rate limit, text-embedding-004 token limit 미확인). Arch Division은 AUD-001~022 (HIGH) 즉시 수정 필요, AUD-023~030 (MEDIUM) 후속 처리 권장."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-035","location":"docs/adr/016-embedding-model-selection.md:28","current":"Max input tokens | 8,192","expected":"Max input tokens | 2,048","evidence":"Official Google docs ai.google.dev/gemini-api/docs/embeddings confirms 2,048. FIX-AUDIT ERR-051 assigned but not yet applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-036","location":"docs/adr/013-six-layer-memory-architecture.md:144,171-174 vs docs/plan/axel-project-plan.md:787-788 vs docs/adr/002-postgresql-single-db.md:77-78","current":"ADR-013 says IVFFlat(lists=100) for L3 Semantic. Plan body says HNSW(m=16,ef=64). ADR-002 says 'HNSW 권장' for 1K-10K, 'IVFFlat 검토' for 10K+. migration-strategy:185 creates IVFFlat.","expected":"Unified index strategy. Plan body (HNSW) contradicts ADR-013 (IVFFlat), migration-strategy (IVFFlat), and ADR-002 reverses the scale guidance vs RES-001.","evidence":"4-way inconsistency. Plan body:787 HNSW. ADR-013:144 IVFFlat. ADR-002:77-78 HNSW@1K/IVFFlat@10K (reverses RES-001 which says IVFFlat@1K/HNSW@50K+). migration-strategy:185-187 IVFFlat SQL."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-037","location":"docs/research/RES-001-pgvector-index-comparison.md:150","current":"Memory calculation uses 1536 dimensions: (1536 × 4) + (16 × 2 × 4) = 6272 bytes/vector","expected":"Should use 3072 dimensions (ADR-016 decision): (3072 × 4) + (16 × 2 × 4) = 12416 bytes/vector. 100K vectors = ~1.18GB (not 597MB). All downstream citations of RES-001 memory/storage figures are now incorrect.","evidence":"ADR-016 confirms 3072d. RES-001 was written before dimension decision. Memory calc is 2x underestimated. ADR-002:77 cites 'RES-001: 7.4x faster queries' — query performance may hold but memory/storage figures do not."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-038","location":"docs/plan/v2-open-items-decisions.md:40-65,177","current":"Section 2 titled 'WebChat Framework: React' with full React rationale table, comparison, and plan impact. Summary table line 177: 'React (Vite)'","expected":"Should reflect ADR-017 decision: Svelte 5 (SvelteKit). Or add superseded notice. 8 React references in this section.","evidence":"ADR-017 status PROPOSED, plan body:259 correctly says 'SvelteKit — ADR-017', plan:2024 says 'Svelte 5 (PLAN-001 React 번복)'. FIX-AUDIT ERR-050 assigned but not applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-039","location":"docs/plan/axel-project-plan.md:843-853 vs docs/plan/migration-strategy.md:285-305","current":"Plan body hot_memories MV uses implicit INNER JOIN via LATERAL+GROUP BY (excludes empty channel_mentions). Migration-strategy uses LEFT JOIN LATERAL+COALESCE (includes empty, channel_diversity=0).","expected":"Both should use the same SQL. Migration-strategy version (LEFT JOIN) is semantically correct per its NOTE comment. Plan body SQL silently drops memories with no channel_mentions.","evidence":"Plan:843 uses 'FROM memories m, LATERAL jsonb_object_keys(...)' which excludes rows where channel_mentions='{}'. Migration-strategy:285 uses LEFT JOIN which includes them. Different result sets."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-040","location":"docs/research/RES-001-pgvector-index-comparison.md:128,134-168","current":"RES-001 references 6 memory layers as L1-L6: Working, Episodic, Semantic, Procedural, Entity, Compressed","expected":"ADR-013 defines 6 layers as M0-M5: Stream Buffer, Working, Episodic, Semantic, Conceptual, Meta. 'Procedural' and 'Compressed' layers do not exist in Axel architecture.","evidence":"ADR-013 (accepted) defines authoritative layer names. RES-001 was written before/concurrently with ADR-013. Layer names and numbers are completely wrong — 'L4: Procedural' and 'L6: Compressed' are not part of Axel."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-041","location":"docs/adr/016-embedding-model-selection.md:69","current":"readonly rateLimitRpm: 1500; // Gemini free tier","expected":"Free tier RPM is 5-15 (post-Dec 2025 cuts per RES-003:75). 1500 RPM appears to be Tier 1/2 paid rate. Comment 'free tier' is incorrect.","evidence":"RES-003:75 says 'Free tier RPM: ~5-15'. Official Google rate limit docs confirm free tier has significantly lower limits post-Dec 2025. FIX-AUDIT ERR-055 assigned but not applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-042","location":"docs/adr/016-embedding-model-selection.md:29","current":"Output dimensions | 3,072 (full) / 1,536 (truncated) / 768 (truncated) / 256 (truncated)","expected":"Output dimensions | 128-3,072 (any integer, flexible). Recommended: 768 / 1,536 / 3,072. 256 is not in Google's recommended list. EMBED-3072 added 1,536 but kept non-standard 256.","evidence":"Official Google docs ai.google.dev/gemini-api/docs/embeddings: 'flexible range of 128-3,072; recommended sizes are 768, 1,536, or 3,072'. 256 is not mentioned as recommended."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-043","location":"docs/adr/016-embedding-model-selection.md:31","current":"MTEB score | 68.32 (#1 ranking, 2026-01 기준)","expected":"68.32 is the mean(task) score per Google blog. Per-dimension scores: 768d=67.99, 1536d/3072d=68.17. ADR should clarify this is the mean score, not the 3072d-specific score.","evidence":"Google Developers Blog 'gemini-embedding-text-model-now-available-gemini-api' states mean(task) score 68.32. Arxiv paper 2503.07891v1 provides per-dimension breakdown."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"LOW","id":"AUD-044","location":"docs/research/RES-003-gemini-embedding-comparison.md:65","current":"Single input per request: Cannot batch multiple texts in one API call (batch API coming soon)","expected":"batchEmbedContents endpoint is available. Google Gemini Batch API supports embeddings at 50% price ($0.075/1M tokens).","evidence":"Google Developers Blog 'gemini-batch-api-now-supports-embeddings-and-openai-compatibility'. Official REST API: models.batchEmbedContents endpoint documented."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"LOW","id":"AUD-045","location":"docs/research/RES-003-gemini-embedding-comparison.md:141,168-183,199-213","current":"RES-003 recommendation section and code examples all use 768d (outputDimensionality: 768, vector(768))","expected":"RES-003 was written before Mark's 3072d directive. Recommendation and code examples are stale. Research document — acceptable as historical record but misleading if referenced without context.","evidence":"Mark directive 0208T1700. RES-003 recommendation 'Use gemini-embedding-001 with 768 dimensions' is superseded by ADR-016 3072d decision."}
{"ts":"0209T0031","from":"audit","type":"done","task":"AUDIT-002","findings_high":4,"findings_medium":5,"findings_low":2,"note":"AUDIT-002: FIX-AUDIT 검증 + 추가 cross-cutting 감사. FIX-AUDIT 미완료 확인 (0 commits on div/arch since EMBED-3072). AUDIT-001의 34개 findings 중: 20 HIGH RESOLVED (EMBED-3072), 2 HIGH OPEN (AUD-021 max tokens, AUD-022 index — FIX-AUDIT), 8 MEDIUM 중 2 RESOLVED (AUD-029 migration logic), 4 LOW 중 1 RESOLVED (AUD-031 index reuse). 신규 11건: 4 HIGH (AUD-035~038: max tokens 재확인, 4-way 인덱스 불일치, RES-001 1536d 메모리 계산 오류, v2-open-items React 잔존), 5 MEDIUM (AUD-039~043: hot_memories SQL 차이, RES-001 layer naming 오류, rateLimitRpm, dimension options, MTEB score 명확화), 2 LOW (AUD-044~045: batch API, RES-003 stale code). 총 미해결: 4 HIGH, 8 MEDIUM, 5 LOW."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-046","location":"packages/infra/src/db/pg-episodic-memory.ts:1-5, pg-semantic-memory.ts:1-8, pg-conceptual-memory.ts:1-7, pg-meta-memory.ts:1, cache/redis-working-memory.ts:1, cache/redis-stream-buffer.ts:1","current":"6 infra files import from packages/core/src/memory/types.js (e.g., import type { EpisodicMemory } from '../../../core/src/memory/types.js')","expected":"CONSTITUTION §9: packages/infra/ may ONLY import from packages/core/src/types/. memory/types.js is NOT within src/types/.","evidence":"CONSTITUTION §9 table: 'packages/infra/ | packages/core/src/types/ only'. These imports use core/src/memory/types.js which is outside the permitted import path. PLAN_SYNC B.7 documents these as cross-package contracts but CONSTITUTION text is strict."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-047","location":"packages/infra/src/llm/anthropic-provider.ts:1-5, llm/google-provider.ts:1-5, mcp/tool-registry.ts:3, db/pg-session-store.ts:1-6","current":"4 infra files import from packages/core/src/orchestrator/types.js (e.g., import type { LlmProvider } from '../../../core/src/orchestrator/types.js')","expected":"CONSTITUTION §9: packages/infra/ may ONLY import from packages/core/src/types/. orchestrator/types.js is NOT within src/types/.","evidence":"CONSTITUTION §9 table: 'packages/infra/ | packages/core/src/types/ only'. PLAN_SYNC B.7 notes LlmProvider was 'moved to core' as DI contract, but placed in orchestrator/types.ts not types/. The PLAN_SYNC acknowledgment doesn't override CONSTITUTION."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-048","location":"packages/infra/src/llm/google-provider.ts:51","current":"let toolCallCounter = 0; — module-level mutable global variable","expected":"No global mutable state (CLAUDE.md preferences: 'no global mutable state', constructor injection for dependencies). toolCallCounter is shared across all GoogleLlmProvider instances and all concurrent requests, causing non-deterministic callId collision.","evidence":"CLAUDE.md coding standards: 'Constructor injection for dependencies (no global mutable state)'. google-provider.ts line 51 declares mutable module-level counter. Concurrent calls from different sessions will share and increment this counter unpredictably."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-049","location":"packages/infra/src/cache/redis-working-memory.ts:38-48 vs docs/adr/003-redis-working-memory.md:120-125","current":"RedisWorkingMemory constructor takes (redis: RedisClient, pg: PgPool) — no CircuitBreaker injection. Uses internal redisState boolean flags instead.","expected":"ADR-003 code example shows constructor with 3 params: (redis, pg, circuitBreaker: CircuitBreaker). ADR-021 mandates explicit circuit breaker state machine. Code uses ad-hoc boolean flag pattern instead of CircuitBreaker from common/circuit-breaker.ts.","evidence":"ADR-003:120-125 constructor(redis, pg, circuitBreaker: CircuitBreaker). Actual code: constructor(redis, pg) with internal { consecutiveFailures, isOpen } object. ADR-021 circuit breaker has proper 3-state FSM (closed/open/half_open). Code only has 2-state (open/not-open) with no half_open probe."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-050","location":"packages/infra/src/db/pg-session-store.ts vs docs/plan/axel-project-plan.md:722-736","current":"PgSessionStore uses sessions table with user_id, channel_history columns. Plan SQL schema (plan:722-736) has NO user_id column and NO channel_history column.","expected":"Plan schema and code should match. Dev-infra sent plan-amendment (PLAN-AMEND-001) for sessions.user_id. SYNC-004 is still IN PROGRESS — plan not yet updated.","evidence":"broadcast.jsonl C43: 'process plan-amendment from dev-infra: sessions table user_id missing in migration-strategy.md'. SYNC-004 stalled 3 cycles (metric-alert). Plan SQL still lacks user_id and channel_history columns."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-051","location":"packages/infra/src/cache/redis-working-memory.ts:52-63","current":"pushTurn() writes to messages table using session_id=$2 with value userId (not actual session_id). SQL: INSERT INTO messages (turn_id, session_id, role, ...) VALUES ($1, $2, ...) with params [turn.turnId, userId, ...]","expected":"session_id column should receive an actual session_id (UUID), not userId. Plan schema (plan:744) defines messages.session_id as TEXT NOT NULL REFERENCES sessions(session_id). Using userId as session_id breaks referential integrity.","evidence":"pg-episodic-memory.ts:47 correctly uses sessionId parameter for messages.session_id. redis-working-memory.ts:53 passes userId as second param which maps to session_id column. This will cause FK violation if sessions table has referential integrity."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-052","location":"packages/infra/src/embedding/index.ts","current":"GeminiEmbeddingService implementation is placed directly in index.ts (182 lines) instead of a dedicated file like gemini-embedding.ts","expected":"Convention in other infra modules: implementation in dedicated file (e.g., anthropic-provider.ts), barrel export in index.ts. The test file is named gemini-embedding.test.ts suggesting the src should be gemini-embedding.ts.","evidence":"All other modules follow pattern: src/db/pg-*.ts + src/db/index.ts (barrel). src/llm/anthropic-provider.ts + src/llm/index.ts (barrel). Embedding breaks this: implementation in index.ts, no barrel separation. Test name 'gemini-embedding.test.ts' mismatches src 'index.ts'."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-053","location":"packages/infra/src/db/pg-episodic-memory.ts:77-88","current":"searchByTopic uses ILIKE '%' || $1 || '%' — parameterized but no pg_trgm index usage. searchByContent (line 91-100) similarly uses ILIKE.","expected":"Plan schema (plan:758) creates gin_trgm_ops index: 'CREATE INDEX idx_messages_content_trgm ON messages USING gin (content gin_trgm_ops)'. ILIKE with '%..%' pattern will NOT use gin_trgm index — requires similarity() or word_similarity() for trigram index utilization. Performance regression on large datasets.","evidence":"PostgreSQL docs: gin_trgm_ops index supports LIKE/ILIKE only for patterns with at least 3 chars and uses index for '%word%' patterns via trigram extraction. However, '% || $1 || %' with dynamic concatenation may not be optimized by planner. pg-semantic-memory.ts correctly uses similarity() function (line 81) for text scoring alongside trigram."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-054","location":"packages/infra/src/mcp/tool-registry.ts:239-244","current":"validatePath uses path.resolve() + startsWith() check. Does NOT resolve symlinks (no fs.realpathSync).","expected":"Security rules (CLAUDE.md): 'Path handling: always validate with path.resolve() + boundary check, block symlink traversal'. Code does resolve() but does NOT block symlinks. A symlink inside basePath could point outside.","evidence":"CLAUDE.md security rules explicitly mention 'block symlink traversal'. tool-registry.ts:239-244 only checks path.resolve().startsWith(basePath) which does not dereference symlinks. fs.realpathSync would resolve symlinks before boundary check. Comment on line 238 says 'Resolves symlinks' but code does not actually call realpath."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-055","location":"packages/infra/src/mcp/tool-registry.ts:179-189","current":"Command allowlist only checks when call.toolName === 'execute_command'. Any other tool can pass command-like args without allowlist check.","expected":"ADR-010 specifies allowlist enforcement for all command execution. Current implementation only guards the specific tool named 'execute_command'. If a tool has a different name but executes commands, it bypasses the allowlist.","evidence":"ADR-010:43 'config.security.commandAllowlist.includes(command)'. Code at tool-registry.ts:179 checks 'call.toolName === \"execute_command\"'. This is a weak enforcement — relies on tool naming convention rather than structural security."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-056","location":"packages/infra/src/llm/anthropic-provider.ts:174-179","current":"handleBlockStop: JSON.parse failure on tool call args silently falls through with empty args {}. No logging or error event.","expected":"Silent failure on tool call JSON parsing could cause tools to execute with missing arguments. Should at minimum log a warning or yield an error event. Tool may produce unexpected results with empty args.","evidence":"anthropic-provider.ts:176 catch block is empty (just passes {} as args). ADR-020 defines error taxonomy including ToolError. Silently swallowing parse errors contradicts ADR-020 principle of explicit error handling."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-057","location":"packages/infra/src/db/pg-semantic-memory.ts:92-123","current":"decay() method fetches ALL memories (SELECT importance FROM memories) into memory, then deletes below threshold. No batch processing, no actual decay calculation.","expected":"ADR-015 defines 8-step decay formula. Plan §3.2 (lines 1010-1085) specifies adaptive decay with recency, access stability, channel diversity factors. PgSemanticMemory.decay() only does threshold-based DELETE — it does not apply the decay formula at all.","evidence":"core/decay/calculator.ts implements the full 8-step formula. But PgSemanticMemory.decay() ignores it — just reads importance and deletes below threshold. The DecayRunConfig only has { threshold: number }, not the full DecayConfig from core/decay/types.ts. The actual decay calculation (updating decayed_importance) is never called from PG adapter."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-058","location":"docs/adr/002-postgresql-single-db.md:23","current":"PostgreSQL 16 + pgvector 0.8","expected":"docker-compose.dev.yml and PLAN_SYNC both specify PostgreSQL 17 + pgvector. ADR-002 still says PostgreSQL 16 + pgvector 0.8.","evidence":"PLAN_SYNC A.1: 'docker-compose.dev.yml | IN_SYNC | PostgreSQL 17 + pgvector + Redis 7'. ADR-002:23 says 'PostgreSQL 16 + pgvector 0.8'. Version mismatch between ADR and actual infrastructure."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-059","location":"packages/infra/src/cache/redis-working-memory.ts:117-128","current":"getSummary() returns null on PG fallback path (line 127: return null). Working memory summary is only available from Redis cache.","expected":"ADR-003: 'PG-first write pattern: PG is source of truth, Redis is read cache'. But getSummary has no PG fallback — if Redis is down or summary is not cached, null is returned even if turns exist in PG.","evidence":"ADR-003 degradation table: 'Working Memory read | PG direct read'. getSummary does not query PG at all on the fallback path (line 127). compress() which creates the summary also only writes to Redis (line 147). Summary data has no PG backing — violates ADR-003 principle that Redis data has PG shadow."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-060","location":"packages/infra/src/db/pg-pool.ts:1","current":"import type { ComponentHealth } from '../../../core/src/types/health.js' — uses relative path ../../../core/src/types/","expected":"packages/infra/package.json has @axel/core as workspace dependency. Should use '@axel/core/types' import path (enabled by DEVOPS-004 subpath exports) instead of fragile relative paths.","evidence":"DEVOPS-004 (done C44) added subpath exports: @axel/core/{types,memory,decay,context,persona,orchestrator}. All infra src files still use relative '../../../core/src/...' paths. While functional, this is fragile and doesn't use the intended package boundary mechanism."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-061","location":"packages/infra/src/mcp/tool-registry.ts:79","current":"defineTool returns ToolDefinition & { __handler, __schema } — internal properties with __ prefix leaked into public API","expected":"Internal handler/schema should not be part of the return type. __handler and __schema are implementation details that pollute the ToolDefinition interface.","evidence":"tool-registry.ts:79 return type includes __handler and __schema. These are consumed by ToolRegistry.register() (line 103) but are exposed to all callers of defineTool(). Considered design smell but not a bug — LOW severity."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-062","location":"packages/infra/src/cache/redis-working-memory.ts:130-151","current":"compress() uses try/catch with empty catch blocks. If redis.lrange fails at line 135, function silently returns without compressing.","expected":"Error handling should at minimum log the failure. ADR-003 specifies 'logger.warn' pattern for Redis failures.","evidence":"ADR-003 code examples show explicit logger.warn() calls on Redis failures. Actual code has bare catch blocks (lines 137,150). Non-critical but inconsistent with ADR-003 specification."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-063","location":"packages/infra/src/db/pg-episodic-memory.ts:59","current":"addMessage() increments turn_count via separate UPDATE query. No transaction wrapping the INSERT + UPDATE.","expected":"INSERT message + UPDATE turn_count should be atomic (single transaction). If UPDATE fails after INSERT succeeds, turn_count will be incorrect. Could use a PG trigger or CTE instead.","evidence":"No explicit transaction handling in any PG adapter methods. PG pool wrapper (pg-pool.ts) does not expose transaction API. All multi-statement operations are non-atomic. LOW severity because turn_count is a convenience counter, not critical data."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-064","location":"packages/infra/src/common/circuit-breaker.ts:39-41","current":"CircuitBreaker constructor uses Partial<CircuitBreakerConfig> spread. If only some fields provided, defaults fill in.","expected":"ADR-021 specifies failureThreshold=5, cooldownMs=60_000, halfOpenMaxProbes=1. Code defaults (line 19-23) match: failureThreshold=5, cooldownMs=60_000, halfOpenMaxProbes=1. PASS — no issue. But halfOpenMaxProbes is defined but never enforced in the state machine logic.","evidence":"CircuitBreaker.execute() allows any number of calls in half_open state (no probe counter). config.halfOpenMaxProbes is declared but unused. First success in half_open resets to closed regardless of probe count. ADR-021 says 'HALF_OPEN (1 probe)' but code doesn't enforce the limit."}
{"ts":"0208C45","from":"audit","type":"done","task":"AUDIT-003","findings_critical":0,"findings_high":6,"findings_medium":8,"findings_low":5,"note":"AUDIT-003: Phase C code audit (INFRA-001~005, COMMON-CB). 19 findings total. === HIGH (6): AUD-046/047 — CONSTITUTION §9 package boundary violation (infra imports from core/memory/types.js and core/orchestrator/types.js, not from core/src/types/ as §9 requires). AUD-048 — global mutable state in google-provider.ts (toolCallCounter). AUD-049 — ADR-003 circuit breaker spec not followed (ad-hoc boolean vs CircuitBreaker class). AUD-050 — plan-code schema mismatch (sessions table user_id/channel_history missing from plan, SYNC-004 stalled). AUD-051 — userId used as session_id in redis-working-memory pushTurn (FK violation risk). === MEDIUM (8): AUD-052 — naming convention break (embedding impl in index.ts). AUD-053 — ILIKE may not use trigram index. AUD-054 — validatePath doesn't resolve symlinks (security rule violation). AUD-055 — command allowlist weak enforcement. AUD-056 — silent JSON parse failure in anthropic tool calls. AUD-057 — decay() doesn't apply ADR-015 formula. AUD-058 — ADR-002 says PG 16 but infra uses PG 17. AUD-059 — getSummary has no PG fallback (violates ADR-003). === LOW (5): AUD-060 — relative imports instead of @axel/core subpath exports. AUD-061 — __handler/__schema leaked in defineTool return type. AUD-062 — empty catch blocks missing logger.warn per ADR-003. AUD-063 — non-atomic INSERT+UPDATE in addMessage. AUD-064 — halfOpenMaxProbes config declared but never enforced. === TDD: PASS (100% — all 13 non-barrel src files had test-first commits). File size: PASS (max 257 lines, limit 400). No circular deps found. No dead code detected."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"HIGH","id":"AUD-065","location":"packages/gateway/src/server.ts:186","current":"WS auth uses query parameter token (/ws?token=<token>). Token appears in URL.","expected":"ADR-019 Section 3 specifies first-message auth pattern (WsAuthMessage {type:'auth',token:string}). Code uses query parameter instead. Token in URL is logged by proxies, appears in browser history, Referer headers.","evidence":"ADR-019:62-89 defines first-message WS auth with 5s timeout. websocket-protocol.md:22-28 also specifies query parameter auth. Contradiction: ADR-019 says first-message, websocket-protocol.md says query param. Gateway implements query param. ADR-019 Alternatives table (line 209) explicitly lists query parameter as rejected alternative due to 'URL에 토큰 노출 (로그, Referer)'."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"HIGH","id":"AUD-066","location":"packages/gateway/src/server.ts:12","current":"GatewayConfig has rateLimitPerMinute field but NO rate limiting is implemented anywhere in server.ts","expected":"Plan L9 (line 1572): 'Security middleware (auth, rate limit, CORS)'. OpenAPI spec (openapi-v1.yaml:1062): 'Rate limit exceeded (30 req/min default)'. ADR-019 endpoint matrix implies rate limiting. No rate limit logic exists in code — unlimited requests accepted.","evidence":"server.ts:12 defines rateLimitPerMinute in config but never references it in any handler. Grep for 'rateLimit' in server.ts shows only the config field declaration at line 12. No middleware, no counter, no 429 response. Plan:327 container shows 'rateLimiter: new RedisRateLimiter(redis, circuitBreaker)' — this service is not created or used in gateway code."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"HIGH","id":"AUD-067","location":"packages/gateway/src/server.ts:104-107","current":"Request body has no size limit. body string accumulates all data chunks without upper bound.","expected":"Missing request body size limit allows memory exhaustion DoS. Any authenticated client can send arbitrarily large request bodies. Plan spec (openapi-v1.yaml:640) specifies content maxLength 32000 chars. No enforcement exists.","evidence":"server.ts:104-107 accumulates req data chunks into unbounded string variable body. No Content-Length check, no byte counter, no stream abort. OpenAPI spec defines content maxLength: 32000 but gateway doesn't validate against it. Standard practice: limit body to ~1MB and reject larger payloads."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-068","location":"packages/gateway/src/server.ts:145-162","current":"CORS allows any origin in corsOrigins list. OPTIONS preflight returns 204 without auth. Non-OPTIONS responses also set CORS headers if origin matches. But CORS headers are NOT set when origin is not in the list — this means credentials (cookies) won't be sent, but CORS headers absence doesn't block simple requests.","expected":"CORS implementation is functionally correct for API protection. However, Access-Control-Allow-Credentials is not set, which means cookies/auth tokens won't be included in cross-origin requests from browsers. This is correct for Bearer token auth but should be explicitly documented. PASS with note.","evidence":"server.ts:145-162 CORS impl. No Vary: Origin header set (minor — may cause cache poisoning in CDN scenarios). No Access-Control-Allow-Credentials (correct for Bearer auth, not cookie-based). Functionally sound but missing Vary: Origin header."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-069","location":"packages/gateway/src/server.ts:359-364","current":"timingSafeEqual returns false immediately when lengths differ, before doing constant-time comparison. This leaks token length via timing side-channel.","expected":"crypto.timingSafeEqual requires equal-length buffers. The early return on length mismatch is a known pattern, but leaks that the token length is wrong. Ideal: pad shorter string to match longer string length, then compare. Or always hash both with HMAC before comparing.","evidence":"server.ts:360 'if (a.length !== b.length) return false' — returns immediately. Attacker can determine correct token length by measuring response times for different-length tokens. For static bearer tokens this is a minor concern (attacker still needs to brute-force the content), but reduces security margin."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-070","location":"packages/gateway/src/server.ts:134-142","current":"500 error handler exposes err.message in development mode: config.env === 'development' ? message : 'Internal Server Error'. message comes from err.message which could contain internal paths, DB connection strings, etc.","expected":"ADR-011 ENV-aware error handling specifies: development mode returns {error, detail, stack, requestId}. Production returns {error, requestId}. Current code partially implements this (no stack trace in development, no detail field). Also, the error classification (classifyError()) from ADR-011 is not implemented — raw err.message is used instead of classified publicMessage.","evidence":"ADR-011:47-66 code example shows classifyError(err) → {status, publicMessage, internalMessage, stack}. Gateway code at line 135 uses raw err.message directly. No error classification, no structured error taxonomy per ADR-020. Partial ADR-011 implementation."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-071","location":"packages/channels/src/telegram/telegram-channel.ts vs plan:1512-1515","current":"TelegramChannel does not implement onDisconnect/onReconnect handlers. Plan specifies reconnection lifecycle with exponential backoff + circuit breaker for all channels.","expected":"Plan L8 (line 1512-1515): 'Reconnection lifecycle (ERR-042 해소) — 채널 연결이 끊어진 경우 자동 재연결 시도. 구현체는 지수 백오프 + circuit breaker 패턴.' DiscordChannel implements onDisconnect/onReconnect. TelegramChannel does not. AxelChannel interface marks these as optional (?), so no type error, but plan intention is all channels should have reconnection.","evidence":"core/types/channel.ts:81-82 defines onDisconnect?/onReconnect? as optional. DiscordChannel (discord-channel.ts:126-131) implements both. TelegramChannel has neither. grammy Bot has built-in reconnection, so external reconnection handlers may be less critical, but plan spec requires them."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-072","location":"packages/gateway/src/server.ts:1-365 vs plan:1577-1597","current":"Gateway implements 4 routes: /health, /health/detailed, /api/v1/chat, /api/v1/chat/stream. Plan L9 specifies 12 routes.","expected":"Plan L9 lists: /health, /health/detailed, /api/v1/chat, /api/v1/chat/stream, /api/v1/memory/search, /api/v1/memory/stats, /api/v1/session/end, /api/v1/tools, /api/v1/tools/execute, /ws, /webhooks/telegram, /webhooks/discord. Gateway only implements 4 HTTP routes + /ws. 8 routes missing. Acceptable as stub implementation, but PLAN_SYNC should mark these as NOT_STARTED.","evidence":"openapi-v1.yaml defines all 12+ routes with full request/response schemas. server.ts:38-43 only registers 4 routes. EDGE-005 BACKLOG description says 'Routes per openapi-v1.yaml: /health, /api/v1/chat, /api/v1/memory/search, /api/v1/session, /ws' — some assigned routes are missing from implementation."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-073","location":"apps/axel/src/container.ts:1-2,11-12 vs CONSTITUTION §9","current":"apps/axel/src/container.ts imports from @axel/core/context, @axel/core/memory, @axel/core/orchestrator, @axel/core/types, @axel/infra — 5 different package paths.","expected":"CONSTITUTION §9: apps/axel/ may import from 'Any packages/*'. This is PASS — apps/ has no import restrictions. However, container.ts imports ContextAssembler and SessionRouter as concrete classes from core (not just types). This means apps/axel/ depends on core implementation details, not just interfaces.","evidence":"CONSTITUTION §9 table: 'apps/axel/ | Any packages/*'. Import analysis: all @axel/* imports are within allowed scope. No violation. But design note: concrete class imports (ContextAssembler, SessionRouter) tightly couple apps/ to core/ implementations."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"LOW","id":"AUD-074","location":"apps/axel/src/main.ts:47-48","current":"gracefulShutdown is called with channels: [] (empty array). No channels are passed to the shutdown handler.","expected":"ADR-021 Section 2 Phase 1: 'Stop channels — channel adapters: disconnect gracefully'. main.ts:48 passes empty channels array, so no channels are stopped during shutdown. This means channel connections (Discord bot, Telegram bot) remain active after SIGTERM.","evidence":"main.ts:47-48 'channels: []' in gracefulShutdown call. The container object doesn't include channels (they aren't created in the current bootstrap flow). When channels are wired in, this needs to be updated. Current state: shutdown doesn't stop channels."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"LOW","id":"AUD-075","location":"packages/channels/src/discord/discord-channel.ts:290-302, packages/channels/src/telegram/telegram-channel.ts:216-228","current":"splitMessage function is duplicated identically in both Discord and Telegram channel files.","expected":"DRY principle. Both files contain the exact same splitMessage(content, maxLength) function. Should be extracted to a shared utility in packages/channels/src/utils/ or similar.","evidence":"discord-channel.ts:290-302 and telegram-channel.ts:216-228 are character-for-character identical implementations of splitMessage(). 13 duplicated lines."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"LOW","id":"AUD-076","location":"apps/axel/src/lifecycle.ts:23","current":"const startTime = Date.now(); — module-level mutable state. Captures time when module is first imported, not when server actually starts.","expected":"startTime should be set when the server starts (in aggregateHealth or startupHealthCheck), not at module import time. If module is imported during test setup, uptime calculation will be incorrect.","evidence":"lifecycle.ts:23 captures Date.now() at module load time. This is a module-level side effect. In tests, this means uptime includes test setup time. Minor issue but inconsistent with 'no global mutable state' principle."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"LOW","id":"AUD-077","location":"apps/axel/src/main.ts vs apps/axel/tests/","current":"main.ts has no corresponding main.test.ts. 4 source files but only 3 test files: config.test.ts, container.test.ts, lifecycle.test.ts. main.ts is untested.","expected":"CONSTITUTION §8: 'All files under packages/*/src/ MUST have a corresponding test file'. apps/axel/src/ is not under packages/ but under apps/ — §8 text may not strictly apply. However, TDD protocol was mandated for BOOTSTRAP-001. main.ts bootstrap function has testable logic (signal handlers, shutdown orchestration).","evidence":"Git log shows test(app) commit created tests for config, container, lifecycle — but not main. main.ts:17-60 contains bootstrap() with config loading, container creation, health check, and signal handler registration. The signal handler and shutdown flow are not tested."}
{"ts":"0208C53","from":"audit","type":"finding","severity":"LOW","id":"AUD-078","location":"packages/gateway/src/server.ts:35","current":"const startedAt = Date.now(); — captures time when createGatewayServer is called, not when start() resolves. Used in handleHealthDetailed for uptime calculation.","expected":"startedAt should be set in start() after the server is actually listening, not when the factory function is invoked. Minor accuracy issue in uptime reporting.","evidence":"server.ts:35 sets startedAt before httpServer is even created (line 46). If there's a delay between createGatewayServer() and start(), uptime will be inflated. Test: createGatewayServer is called in beforeEach, start() immediately after — negligible impact in practice."}
{"ts":"0208C53","from":"audit","type":"done","task":"AUDIT-004","findings_critical":0,"findings_high":3,"findings_medium":6,"findings_low":5,"note":"AUDIT-004: Phase D code audit — EDGE-003 (Discord), EDGE-004 (Telegram), EDGE-005 (Gateway), BOOTSTRAP-001 (DI). 14 findings total. === TDD: PASS (4/4 components have test-first commits: RED→GREEN order verified for Discord, Telegram, Gateway, Bootstrap). === §9 Package Boundary: PASS (channels imports from @axel/core/types only; gateway imports from @axel/core/types only; apps/axel imports from all packages — allowed per §9). === §14 File Size: PASS (max 364 lines server.ts, limit 400). === HIGH (3): AUD-065 — WS auth uses query parameter instead of ADR-019 first-message pattern (token in URL). AUD-066 — rateLimitPerMinute config field declared but NO rate limiting implemented (plan spec requires it). AUD-067 — no request body size limit (DoS vector, OpenAPI specifies maxLength 32000). === MEDIUM (6): AUD-068 — CORS missing Vary: Origin header (CDN cache poisoning risk). AUD-069 — timingSafeEqual leaks token length via early return. AUD-070 — partial ADR-011 implementation (no classifyError, no error taxonomy). AUD-071 — Telegram missing onDisconnect/onReconnect (plan ERR-042 spec). AUD-072 — 8/12 plan routes not implemented (stub acceptable but PLAN_SYNC gap). AUD-073 — concrete class imports in apps/ (design note, not violation). === LOW (5): AUD-074 — shutdown passes empty channels array. AUD-075 — splitMessage duplicated in Discord+Telegram. AUD-076 — module-level startTime (lifecycle.ts). AUD-077 — main.ts has no test file. AUD-078 — startedAt set before server start. === SECURITY SUMMARY: Gateway auth is functional (timing-safe Bearer). CORS works. Error redaction works for production (dev mode exposes err.message). WS auth functional but uses rejected pattern from ADR-019. Critical gap: no rate limiting and no body size limit. === No circular deps. No dead code (except addReaction no-op in Discord — documented). No files >400 lines."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"HIGH","id":"AUD-079","location":"packages/gateway/src/ws-handler.ts:23,37,69","current":"WebSocket messages (auth and chat) have no size limit. data.toString() on arbitrarily large payloads can cause memory exhaustion.","expected":"WS message size limit matching HTTP body limit (32KB). ws.on('message') should check data.length before JSON.parse. HTTP has MAX_BODY_BYTES=32768 (server.ts:15) but WS has no equivalent.","evidence":"server.ts:15 defines MAX_BODY_BYTES=32768 for HTTP. ws-handler.ts has no size check on data parameter. Large WS messages bypass HTTP body limit. JSON.parse on multi-MB payloads can cause OOM or CPU spike."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"HIGH","id":"AUD-080","location":"packages/gateway/src/server.ts:157-175","current":"Rate limit bucket Map grows unbounded. Empty timestamp arrays are never removed from rateLimitBuckets Map.","expected":"After removing expired timestamps, if array is empty, delete the IP key from Map. Long-running server accumulates Map entries for every unique IP that ever made a request. Memory leak.","evidence":"server.ts:168-170 removes old timestamps but line 165 rateLimitBuckets.set(clientIp, timestamps) persists empty arrays indefinitely. No periodic cleanup, no LRU eviction. Production server receiving traffic from many IPs will accumulate unbounded Map entries."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"HIGH","id":"AUD-081","location":"packages/core/src/orchestrator/inbound-handler.ts:97","current":"Catch block discards error completely (_err: unknown). No logging, no telemetry, no error type inspection. Silent failure.","expected":"ADR-020 error taxonomy requires classified error handling. ADR-011 requires environment-aware error reporting. At minimum: log error with context (userId, channelId, error message/stack) for operators. Current: error vanishes silently, making production debugging impossible.","evidence":"inbound-handler.ts:97 'catch (_err: unknown)' — underscore prefix indicates intentional discard. No console.error, no logger call, no error event emission. Only a generic Korean error message is sent to user. Compare: react-loop.ts properly yields error events for each error type (ADR-020 compliance)."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"HIGH","id":"AUD-082","location":"packages/gateway/src/server.ts:252-256, ws-handler.ts:121","current":"Gateway constructs InboundMessage without timestamp field. server.ts:252 and ws-handler.ts:121 pass {userId, channelId, content} — missing required timestamp:Date.","expected":"InboundMessage interface (core/types/channel.ts) requires timestamp: Date. inbound-handler.ts:142 uses inbound.timestamp in Message construction. Missing timestamp means undefined is passed to Message.timestamp, corrupting downstream data.","evidence":"core/types/channel.ts InboundMessage defines 'timestamp: Date' as required. server.ts:252 omits it. ws-handler.ts:121 omits it. TypeScript may not catch this if handleMessage signature is loosely typed. inbound-handler.ts:142 reads inbound.timestamp — will be undefined at runtime."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"HIGH","id":"AUD-083","location":"tools/migrate/src/cli.ts:11-12","current":"Hardcoded database credentials in fallback: 'postgresql://postgres:postgres@localhost:5432/axel_dev'","expected":"NEVER provide default credentials (security rules). CLI should fail loudly if DATABASE_URL is not set. Hardcoded postgres:postgres credentials are visible in source code, risk of accidental production connection with weak credentials.","evidence":"CLAUDE.md security rules: 'NEVER hardcode API keys, tokens, or secrets in source code'. cli.ts:11-12 uses ?? operator with hardcoded connection string containing username 'postgres' and password 'postgres'. If deployed without DATABASE_URL env var, connects to default DB with known weak credentials."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-084","location":"tools/migrate/src/migrator.ts:70,109","current":"Migration SQL files are loaded from disk and executed directly via client.query(migration.upSql) without any content validation.","expected":"While migration tools inherently execute SQL, the tool should validate against dangerous patterns (COPY TO PROGRAM, CREATE EXTENSION with untrusted languages). Migration files are part of the supply chain — compromised files execute arbitrary SQL with elevated privileges.","evidence":"migrator.ts:70 'await this.client.query(migration.upSql)' and :109 'await this.client.query(migration.downSql)'. No validation of SQL content. Transaction wrapping is correct (BEGIN/COMMIT/ROLLBACK) but does not prevent malicious SQL execution. MEDIUM because migration files are developer-authored and committed to git (supply chain trust), not user-supplied."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-085","location":"tools/migrate/src/migrator.ts:135-136","current":"Migration file paths constructed via join(migrationsDir, upFile) without symlink resolution. Path boundary check missing.","expected":"Security rules: 'Path handling: always validate with path.resolve() + boundary check, block symlink traversal'. migrator.ts uses join() without resolve() or realpath(). A symlink in migrations directory could read files outside the intended directory.","evidence":"CLAUDE.md security: 'block symlink traversal'. migrator.ts:135-136 join() does not resolve symlinks. readdir() returns filenames but symlinks in the directory are followed by readFile(). Attack vector requires filesystem write access to migrations dir. MEDIUM because migration directory is developer-controlled, not user-accessible."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-086","location":"packages/gateway/src/http-utils.ts:4-6","current":"HTTP responses lack security headers: X-Content-Type-Options, X-Frame-Options not set.","expected":"Production API gateway should include: X-Content-Type-Options: nosniff (prevent MIME sniffing), X-Frame-Options: DENY (prevent clickjacking). These are standard security hardening headers for HTTP APIs.","evidence":"http-utils.ts:5 sendJson sets only Content-Type header. No X-Content-Type-Options, no X-Frame-Options. OWASP recommendation for all HTTP responses. MEDIUM because this is an API (not browser-rendered HTML), reducing clickjacking risk, but MIME sniffing is still relevant."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-087","location":"packages/gateway/src/server.ts:157-158","current":"Rate limiting uses req.socket.remoteAddress which shows proxy IP when behind reverse proxy (nginx, Cloudflare).","expected":"Behind reverse proxy, all requests appear from same IP, making rate limiting ineffective. Should support X-Forwarded-For with trusted proxy configuration, or document direct-exposure requirement.","evidence":"server.ts:158 'req.socket.remoteAddress'. Standard deployment uses reverse proxy → all requests show proxy IP. rate limiting becomes per-proxy not per-client. ADR-019 does not specify proxy trust configuration. MEDIUM because single-user model (Axel) mitigates impact, but gateway is designed for multi-client access."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-088","location":"packages/infra/tests/integration/pg-redis-integration.test.ts:40-48","current":"Hardcoded fallback credentials: password 'axel_dev_password' in pgAdminConfig(), user 'axel' in config defaults.","expected":"Test should fail if env vars not set (testcontainers should provide them). Fallback to hardcoded credentials risks connecting to local dev database accidentally. Should throw if PGHOST/PGPASSWORD not set.","evidence":"pg-redis-integration.test.ts:46 'password: process.env.PGPASSWORD || \"axel_dev_password\"'. If testcontainers setup fails or is skipped, test connects to local PG with known password. Violates principle of explicit configuration. MEDIUM because this is test code, not production, but credential hygiene matters."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-089","location":"packages/infra/src/db/pg-episodic-memory.ts:1, pg-meta-memory.ts:1, cache/redis-working-memory.ts:1, cache/redis-stream-buffer.ts:1, llm/anthropic-provider.ts:1, llm/google-provider.ts:1, mcp/tool-registry.ts:3","current":"7 infra src files import from @axel/core/memory or @axel/core/orchestrator. CONSTITUTION §9 permits ONLY @axel/core/types.","expected":"§9 violation unchanged from AUDIT-003 (AUD-046/047). CONST-AMEND-001 queued but not yet approved. Reporting for completeness — these are existing violations that persist through Phase E. No new violations introduced by Phase E integration code.","evidence":"AUDIT-003 AUD-046/047. CONST-AMEND-001 in BACKLOG Queued. Infra imports @axel/core/memory (4 files) and @axel/core/orchestrator (3 files). All are type-only imports. Gateway and channels PASS §9 (gateway only imports @axel/core/types)."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-090","location":"packages/gateway/src/route-handlers.ts:80","current":"handleSessionEnd extracts sessionId via unsafe cast: (session as Record<string, unknown>).sessionId as string. No runtime validation.","expected":"Should use proper type narrowing or Zod validation. If session object shape changes or sessionId is missing, this will pass undefined to endSession, causing silent failure or runtime error. ADR-005 mandates Zod for external input validation.","evidence":"route-handlers.ts:80 double-cast pattern (as Record → .sessionId as string) bypasses TypeScript safety. If deps.getSession returns an object without sessionId property, String(undefined) = 'undefined' is passed to endSession. Should validate: typeof sessionId === 'string' && sessionId.length > 0."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"LOW","id":"AUD-091","location":"packages/gateway/src/http-utils.ts, ws-handler.ts, route-handlers.ts, types.ts","current":"4 gateway source files have no corresponding test files. Tests exist for server.ts, websocket.ts, classify-error.ts, cors-vary.ts, remaining-routes.ts, integration.ts — but http-utils.ts, ws-handler.ts, route-handlers.ts, types.ts have no dedicated test file.","expected":"CONSTITUTION §8: test file for each source file. http-utils.ts contains security-critical timingSafeEqual. ws-handler.ts contains auth logic. route-handlers.ts contains input validation. These are tested indirectly via server/websocket tests but lack isolated unit tests.","evidence":"Glob packages/gateway/tests/ shows: server.test.ts, websocket.test.ts, remaining-routes.test.ts, integration.test.ts, classify-error.test.ts, cors-vary.test.ts, setup.ts. Missing: http-utils.test.ts, ws-handler.test.ts, route-handlers.test.ts, types.test.ts. LOW because §8 text says 'packages/*/src/' and functions are tested indirectly."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"LOW","id":"AUD-092","location":"tools/migrate/src/cli.ts","current":"cli.ts has no corresponding test file. tools/migrate/tests/ only has migrator.test.ts.","expected":"CLI entry point with command routing, argument parsing, and error handling should have unit tests. Currently untested: 'up' without version (upAll path), 'down' without version (error path), 'status' output format, unknown command handling.","evidence":"Glob tools/migrate/tests/ shows only migrator.test.ts. No cli.test.ts. cli.ts has 5 distinct code paths (up+version, up all, down, status, default) — none tested directly. LOW because CLI is a thin wrapper around Migrator which is tested."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"LOW","id":"AUD-093","location":"packages/core/src/orchestrator/inbound-handler.ts:82","current":"reactLoop called with tools: [] (empty array). No tools are passed to the LLM, making tool execution impossible.","expected":"InboundHandler should receive tool definitions from ToolRegistry (via DI) and pass them to reactLoop. Plan L7 (line 1396-1401): 'tools: ToolDefinition[] — available tools for the loop'. Currently hardcoded empty array means Axel cannot use any tools in conversation. Likely a Phase E placeholder to be wired in INTEG-005.","evidence":"inbound-handler.ts:82 'tools: []'. InboundHandlerDeps includes toolExecutor but no toolRegistry or tools list. The tools are available for execution (toolExecutor) but never offered to the LLM (empty tools array). This means the LLM will never generate tool_call events. Expected to be resolved in INTEG-005 or follow-up task."}
{"ts":"0208C58","from":"audit","type":"finding","severity":"LOW","id":"AUD-094","location":"packages/gateway/src/server.ts:21","current":"startedAt = Date.now() set when createGatewayServer() is called, not when start() resolves. Uptime reported by /health/detailed may be inflated.","expected":"startedAt should be set inside start() after httpServer.listen() callback. Currently captures factory invocation time, not actual server start time. Minor accuracy issue. Carried over from AUDIT-004 AUD-078 — not yet fixed.","evidence":"AUDIT-004 AUD-078. server.ts:21 'const startedAt = Date.now()' in createGatewayServer scope. server.ts:226 uses startedAt for uptime calculation. Difference between factory call and listen() is typically <100ms. LOW impact."}
{"ts":"0208C58","from":"audit","type":"done","task":"AUDIT-005","findings_critical":0,"findings_high":5,"findings_medium":7,"findings_low":4,"note":"AUDIT-005: Phase E integration security audit (INTEG-001~006, FIX-GATEWAY-001). 16 new findings (AUD-079~094). === RESOLVED FROM AUDIT-004: AUD-065 WS auth FIXED (first-message pattern implemented in ws-handler.ts), AUD-066 rate limiting FIXED (sliding window in server.ts:157-175), AUD-067 body size limit FIXED (32KB in server.ts:15,110-119), AUD-068 CORS Vary FIXED (server.ts:184), AUD-072 missing routes FIXED (6 routes added in route-handlers.ts via INTEG-004). AUD-075 splitMessage FIXED (extracted to channels/src/utils/split-message.ts via FIX-MEDIUM-001). === HIGH (5): AUD-079 WS message size limit missing (DoS vector). AUD-080 rate limit bucket memory leak. AUD-081 silent error discard in InboundHandler (no logging). AUD-082 missing timestamp in gateway→InboundMessage construction. AUD-083 hardcoded DB credentials in migrate CLI. === MEDIUM (7): AUD-084 migration SQL unvalidated execution. AUD-085 migration file path no symlink check. AUD-086 missing security headers. AUD-087 rate limit proxy-unaware. AUD-088 test hardcoded credentials. AUD-089 §9 boundary violations persisting (CONST-AMEND-001 pending). AUD-090 unsafe cast in handleSessionEnd. === LOW (4): AUD-091 4 gateway files missing dedicated test. AUD-092 cli.ts no test. AUD-093 tools:[] empty in InboundHandler. AUD-094 startedAt timing (AUD-078 recurrence). === TDD: 6 violations found (4 gateway utilities, 1 app entry point, 1 tool CLI) — all are indirect-tested via integration tests but lack dedicated unit test files. === §9 PACKAGE BOUNDARY: PASS for Phase E new code (gateway imports @axel/core/types only, channels imports @axel/core/types only). Infra §9 violations persist unchanged from AUDIT-003. === §14 FILE SIZE: PASS (max 321 lines server.ts, limit 400). === DEAD CODE: PASS (0 unused imports, 0 commented-out blocks, 0 unreachable code). === SECURITY SUMMARY: FIX-GATEWAY-001 resolved 3 critical gaps (WS auth, rate limit, body size). Gateway auth flow is correct (timing-safe Bearer HTTP, first-message WS per ADR-019). Error redaction works (classifyError). New concerns: WS has no message size limit, rate limit has memory leak, InboundHandler silently drops errors, gateway sends InboundMessage without required timestamp."}
