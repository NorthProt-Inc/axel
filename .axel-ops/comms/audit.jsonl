{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-001","location":"docs/plan/axel-project-plan.md:594","current":"embeddingDimension: z.number().int().default(768)","expected":"embeddingDimension: z.number().int().default(3072)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43 — Mark confirms full 3072d, NOT truncated 768d"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-002","location":"docs/plan/axel-project-plan.md:770","current":"embedding vector(768) NOT NULL -- pgvector: 768d (Gemini embedding-001)","expected":"embedding vector(3072) NOT NULL -- pgvector: 3072d (Gemini embedding-001)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-003","location":"docs/plan/axel-project-plan.md:978-979","current":"axnmihn: ChromaDB (별도 프로세스), 768d / Axel: pgvector (같은 DB), 768d","expected":"Axel line should read 3072d (axnmihn historical reference 768d is correct)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-004","location":"docs/plan/axel-project-plan.md:1705","current":"ChromaDB (1000+ vectors, 768d) → pgvector (re-embed or direct copy)","expected":"pgvector target should specify 3072d","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-005","location":"docs/plan/axel-project-plan.md:1715","current":"결정: Re-embed (gemini-embedding-001, 768d)","expected":"결정: Re-embed (gemini-embedding-001, 3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-006","location":"docs/plan/axel-project-plan.md:1721","current":"768d 차원 유지 → pgvector 컬럼 타입 변경 불필요","expected":"3072d로 변경 — pgvector 컬럼 타입 vector(3072)으로 변경 필요","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-007","location":"docs/plan/axel-project-plan.md:2023","current":"ADR-016 | Embedding Model: gemini-embedding-001 (768d)","expected":"ADR-016 | Embedding Model: gemini-embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-008","location":"docs/plan/axel-project-plan.md:2038","current":"gemini-embedding-001 (768d) — ADR-016","expected":"gemini-embedding-001 (3072d) — ADR-016","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-009","location":"docs/plan/axel-project-plan.md:301","current":"readonly dimension: number; // e.g., 768","expected":"readonly dimension: number; // e.g., 3072","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-010","location":"docs/adr/016-embedding-model-selection.md:20","current":"gemini-embedding-001 (768d, Matryoshka truncation) 사용","expected":"gemini-embedding-001 (3072d, full dimension) 사용. Mark의 결정으로 truncation 사용하지 않음.","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-011","location":"docs/adr/016-embedding-model-selection.md:36-48","current":"Dimension Choice: 768d 섹션 전체 (768d 선택 근거 4개)","expected":"Dimension Choice: 3072d로 변경. 근거: Mark의 결정 — full precision 우선, 저장 공간 trade-off 수용","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-012","location":"docs/adr/016-embedding-model-selection.md:65","current":"readonly dimension: 768;","expected":"readonly dimension: 3072;","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-013","location":"docs/adr/016-embedding-model-selection.md:140","current":"embeddingDimension: z.number().int().default(768)","expected":"embeddingDimension: z.number().int().default(3072)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-014","location":"docs/adr/013-six-layer-memory-architecture.md:143","current":"Gemini embedding-001 (768d)","expected":"Gemini embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-015","location":"docs/adr/002-postgresql-single-db.md:36","current":"memories + vector(768) — Semantic Memory (Layer 3, pgvector)","expected":"memories + vector(3072) — Semantic Memory (Layer 3, pgvector)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-016","location":"docs/plan/migration-strategy.md:163","current":"embedding vector(768) NOT NULL","expected":"embedding vector(3072) NOT NULL","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-017","location":"docs/plan/migration-strategy.md:463","current":"Axel uses gemini-embedding-001 (768d, PLAN-001 decision)","expected":"Axel uses gemini-embedding-001 (3072d, HUMAN DIRECTIVE override)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-018","location":"docs/plan/migration-strategy.md:474","current":"Call Gemini gemini-embedding-001 API (768d output)","expected":"Call Gemini gemini-embedding-001 API (3072d output)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-019","location":"docs/plan/v2-open-items-decisions.md:11,15","current":"Embedding Model: gemini-embedding-001 (768d) / 768d, Matryoshka truncation","expected":"gemini-embedding-001 (3072d) / 3072d, full dimension (no truncation)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2000","from":"audit","type":"finding","severity":"HIGH","id":"AUD-020","location":"docs/plan/v2-open-items-decisions.md:176","current":"gemini-embedding-001 (768d)","expected":"gemini-embedding-001 (3072d)","evidence":"HUMAN DIRECTIVE broadcast.jsonl:43"}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"HIGH","id":"AUD-021","location":"docs/adr/016-embedding-model-selection.md:28","current":"Max input tokens | 8,192","expected":"Max input tokens | 2,048","evidence":"Official Google docs: ai.google.dev/gemini-api/docs/embeddings confirms 2,048. The 8,192 figure appears to be from experimental model gemini-embedding-exp-03-07. GA model is 2,048."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"HIGH","id":"AUD-022","location":"docs/plan/migration-strategy.md:186 vs docs/plan/axel-project-plan.md:787","current":"migration-strategy uses IVFFlat (lists=100) index; plan body uses HNSW (m=16, ef_construction=64) index","expected":"Both should use HNSW as plan body Section 4 Layer 3 specifies. Migration-strategy.md migration 003 is inconsistent.","evidence":"Plan:787 says 'HNSW 권장 (RES-001: 7.4x faster queries, better recall)'. Migration SQL at migration-strategy.md:185-187 creates IVFFlat index instead."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-023","location":"docs/adr/016-embedding-model-selection.md:29","current":"Output dimensions | 3,072 (full) / 768 (truncated) / 256 (truncated)","expected":"Output dimensions | 128-3,072 (flexible). Recommended: 768 / 1,536 / 3,072","evidence":"Official Google docs: supports any integer 128-3072. Recommended values are 768, 1536, 3072. ADR omits 1536 entirely and includes non-recommended 256."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-024","location":"docs/adr/016-embedding-model-selection.md:34","current":"Task types: RETRIEVAL_DOCUMENT, RETRIEVAL_QUERY, SEMANTIC_SIMILARITY, CLASSIFICATION, CLUSTERING (5 types)","expected":"8 task types including CODE_RETRIEVAL_QUERY, QUESTION_ANSWERING, FACT_VERIFICATION","evidence":"Official Google docs: ai.google.dev/gemini-api/docs/embeddings lists 8 task types. ADR-016 missing 3."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-025","location":"docs/adr/016-embedding-model-selection.md:31","current":"MTEB score | 68.32 (#1 ranking, 2026-01 기준)","expected":"MTEB score | 68.16 (3072d GA model) or 68.32 (experimental model). Should clarify which.","evidence":"Google official docs show 768d=67.99, 3072d=68.16 for GA model. 68.32 was the experimental model score (gemini-embedding-exp-03-07)."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-026","location":"docs/research/RES-003-gemini-embedding-comparison.md:65","current":"Single input per request: Cannot batch multiple texts in one API call (batch API coming soon)","expected":"batchEmbedContents endpoint exists and was available at GA launch. Up to 250 texts per request (Vertex AI).","evidence":"Official Google API: models.batchEmbedContents endpoint documented. Vertex AI docs confirm 250 text limit per batch request."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-027","location":"docs/plan/v2-open-items-decisions.md:40-65","current":"PLAN-001 Section 2 says 'React (Vite)' for WebChat","expected":"ADR-017 superseded this to Svelte 5 (SvelteKit). PLAN-001 document not updated.","evidence":"ADR-017 status: PROPOSED. Plan main body at line 259 correctly says 'SvelteKit — ADR-017'. But PLAN-001 (v2-open-items-decisions.md) still says React."}
{"ts":"0208T2001","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-028","location":"docs/research/RES-003-gemini-embedding-comparison.md:29","current":"Max tokens: 2,048 input tokens","expected":"Correct (2,048). But ADR-016 says 8,192. RES-003 is correct, ADR-016 is wrong.","evidence":"Cross-reference: RES-003:29 correct vs ADR-016:28 incorrect. ADR-016 should have used RES-003 value."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-029","location":"docs/plan/axel-project-plan.md:1721-1722","current":"768d 차원 유지 → pgvector 컬럼 타입 변경 불필요 / 향후 3,072d 업그레이드 가능","expected":"3072d 변경으로 인해 이 두 줄의 논리가 뒤바뀜: 컬럼 타입 변경 필요(768→3072), 업그레이드 불필요(이미 full dim)","evidence":"HUMAN DIRECTIVE 768d→3072d 전환으로 마이그레이션 전략 논리 자체가 변경됨"}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-030","location":"docs/plan/migration-strategy.md:180-187","current":"IVFFlat index created with lists=100 for initial ~1,000 vectors. Comment says switch to HNSW at 10,000+","expected":"With 3072d vectors, IVFFlat vs HNSW trade-off changes. 3072d vectors require more memory — HNSW m=16 at 3072d = ~25KB/vector. Storage impact needs recalculation.","evidence":"RES-001 performance data was based on 1536d vectors. 3072d doubles the per-vector storage. IVFFlat lists=100 guidance was for 768d. Needs reassessment for 3072d."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-031","location":"docs/adr/016-embedding-model-selection.md:123","current":"768d로 axnmihn IVFFlat 인덱스 설정(lists=100) 재사용 가능","expected":"3072d 변경 시 이 advantage는 무효. Consequences 섹션 수정 필요.","evidence":"HUMAN DIRECTIVE 768d→3072d. axnmihn 인덱스 설정 재사용 불가."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-032","location":"docs/research/RES-003-gemini-embedding-comparison.md:135","current":"Storage (100K vectors): 1.17 GB (3072-dim) / 293 MB (768-dim)","expected":"Correct values. With 3072d decision, Axel storage for 100K vectors = ~1.17 GB. Plan cost estimates should reflect this.","evidence":"Storage calculation: 3072 × 4 bytes × 100K = ~1.17 GB. This is informational, no error in RES-003."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-033","location":"docs/adr/016-embedding-model-selection.md:68","current":"readonly rateLimitRpm: 1500; // Gemini free tier","expected":"RES-003 reports free tier RPM as 5-15 (post-Dec 2025 cuts). 1500 RPM is paid tier or pre-cut free tier.","evidence":"RES-003:75-76 says 'Free tier RPM: ~5-15 (post-Dec 2025 cuts)'. ADR-016 rateLimitRpm=1500 appears to be paid tier rate or outdated."}
{"ts":"0208T2002","from":"audit","type":"finding","severity":"LOW","id":"AUD-034","location":"docs/research/RES-003-gemini-embedding-comparison.md:64","current":"Max tokens: 2,048 input tokens (lower than text-embedding-004's 3,000 tokens)","expected":"text-embedding-004 max tokens was 2,048, not 3,000. Multiple lines in RES-003 claim 3,000 for text-embedding-004.","evidence":"NEEDS_VERIFICATION — Google deprecated text-embedding-004 docs may no longer be available. RES-003 lines 91,99,129 claim 3,000 tokens for text-embedding-004. Some sources say 2,048. Could not conclusively verify since model is shutdown."}
{"ts":"0208T2003","from":"audit","type":"done","task":"AUDIT-001","findings_high":22,"findings_medium":8,"findings_low":4,"note":"AUDIT-001 완료. 총 34개 findings. HIGH 22건 중 20건은 768d→3072d 차원 변경(Mark 지시), 1건은 ADR-016 max input tokens 오류(8192→2048), 1건은 IVFFlat/HNSW 인덱스 불일치. MEDIUM 8건은 공식 스펙 오류(dimension options, task types, MTEB score, batch API) 및 PLAN-001 React→Svelte 미갱신. LOW 4건은 부수적 영향(인덱스 재사용, 저장공간, rate limit, text-embedding-004 token limit 미확인). Arch Division은 AUD-001~022 (HIGH) 즉시 수정 필요, AUD-023~030 (MEDIUM) 후속 처리 권장."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-035","location":"docs/adr/016-embedding-model-selection.md:28","current":"Max input tokens | 8,192","expected":"Max input tokens | 2,048","evidence":"Official Google docs ai.google.dev/gemini-api/docs/embeddings confirms 2,048. FIX-AUDIT ERR-051 assigned but not yet applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-036","location":"docs/adr/013-six-layer-memory-architecture.md:144,171-174 vs docs/plan/axel-project-plan.md:787-788 vs docs/adr/002-postgresql-single-db.md:77-78","current":"ADR-013 says IVFFlat(lists=100) for L3 Semantic. Plan body says HNSW(m=16,ef=64). ADR-002 says 'HNSW 권장' for 1K-10K, 'IVFFlat 검토' for 10K+. migration-strategy:185 creates IVFFlat.","expected":"Unified index strategy. Plan body (HNSW) contradicts ADR-013 (IVFFlat), migration-strategy (IVFFlat), and ADR-002 reverses the scale guidance vs RES-001.","evidence":"4-way inconsistency. Plan body:787 HNSW. ADR-013:144 IVFFlat. ADR-002:77-78 HNSW@1K/IVFFlat@10K (reverses RES-001 which says IVFFlat@1K/HNSW@50K+). migration-strategy:185-187 IVFFlat SQL."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-037","location":"docs/research/RES-001-pgvector-index-comparison.md:150","current":"Memory calculation uses 1536 dimensions: (1536 × 4) + (16 × 2 × 4) = 6272 bytes/vector","expected":"Should use 3072 dimensions (ADR-016 decision): (3072 × 4) + (16 × 2 × 4) = 12416 bytes/vector. 100K vectors = ~1.18GB (not 597MB). All downstream citations of RES-001 memory/storage figures are now incorrect.","evidence":"ADR-016 confirms 3072d. RES-001 was written before dimension decision. Memory calc is 2x underestimated. ADR-002:77 cites 'RES-001: 7.4x faster queries' — query performance may hold but memory/storage figures do not."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"HIGH","id":"AUD-038","location":"docs/plan/v2-open-items-decisions.md:40-65,177","current":"Section 2 titled 'WebChat Framework: React' with full React rationale table, comparison, and plan impact. Summary table line 177: 'React (Vite)'","expected":"Should reflect ADR-017 decision: Svelte 5 (SvelteKit). Or add superseded notice. 8 React references in this section.","evidence":"ADR-017 status PROPOSED, plan body:259 correctly says 'SvelteKit — ADR-017', plan:2024 says 'Svelte 5 (PLAN-001 React 번복)'. FIX-AUDIT ERR-050 assigned but not applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-039","location":"docs/plan/axel-project-plan.md:843-853 vs docs/plan/migration-strategy.md:285-305","current":"Plan body hot_memories MV uses implicit INNER JOIN via LATERAL+GROUP BY (excludes empty channel_mentions). Migration-strategy uses LEFT JOIN LATERAL+COALESCE (includes empty, channel_diversity=0).","expected":"Both should use the same SQL. Migration-strategy version (LEFT JOIN) is semantically correct per its NOTE comment. Plan body SQL silently drops memories with no channel_mentions.","evidence":"Plan:843 uses 'FROM memories m, LATERAL jsonb_object_keys(...)' which excludes rows where channel_mentions='{}'. Migration-strategy:285 uses LEFT JOIN which includes them. Different result sets."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-040","location":"docs/research/RES-001-pgvector-index-comparison.md:128,134-168","current":"RES-001 references 6 memory layers as L1-L6: Working, Episodic, Semantic, Procedural, Entity, Compressed","expected":"ADR-013 defines 6 layers as M0-M5: Stream Buffer, Working, Episodic, Semantic, Conceptual, Meta. 'Procedural' and 'Compressed' layers do not exist in Axel architecture.","evidence":"ADR-013 (accepted) defines authoritative layer names. RES-001 was written before/concurrently with ADR-013. Layer names and numbers are completely wrong — 'L4: Procedural' and 'L6: Compressed' are not part of Axel."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-041","location":"docs/adr/016-embedding-model-selection.md:69","current":"readonly rateLimitRpm: 1500; // Gemini free tier","expected":"Free tier RPM is 5-15 (post-Dec 2025 cuts per RES-003:75). 1500 RPM appears to be Tier 1/2 paid rate. Comment 'free tier' is incorrect.","evidence":"RES-003:75 says 'Free tier RPM: ~5-15'. Official Google rate limit docs confirm free tier has significantly lower limits post-Dec 2025. FIX-AUDIT ERR-055 assigned but not applied.","status":"OPEN_FIX_AUDIT"}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-042","location":"docs/adr/016-embedding-model-selection.md:29","current":"Output dimensions | 3,072 (full) / 1,536 (truncated) / 768 (truncated) / 256 (truncated)","expected":"Output dimensions | 128-3,072 (any integer, flexible). Recommended: 768 / 1,536 / 3,072. 256 is not in Google's recommended list. EMBED-3072 added 1,536 but kept non-standard 256.","evidence":"Official Google docs ai.google.dev/gemini-api/docs/embeddings: 'flexible range of 128-3,072; recommended sizes are 768, 1,536, or 3,072'. 256 is not mentioned as recommended."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-043","location":"docs/adr/016-embedding-model-selection.md:31","current":"MTEB score | 68.32 (#1 ranking, 2026-01 기준)","expected":"68.32 is the mean(task) score per Google blog. Per-dimension scores: 768d=67.99, 1536d/3072d=68.17. ADR should clarify this is the mean score, not the 3072d-specific score.","evidence":"Google Developers Blog 'gemini-embedding-text-model-now-available-gemini-api' states mean(task) score 68.32. Arxiv paper 2503.07891v1 provides per-dimension breakdown."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"LOW","id":"AUD-044","location":"docs/research/RES-003-gemini-embedding-comparison.md:65","current":"Single input per request: Cannot batch multiple texts in one API call (batch API coming soon)","expected":"batchEmbedContents endpoint is available. Google Gemini Batch API supports embeddings at 50% price ($0.075/1M tokens).","evidence":"Google Developers Blog 'gemini-batch-api-now-supports-embeddings-and-openai-compatibility'. Official REST API: models.batchEmbedContents endpoint documented."}
{"ts":"0209T0030","from":"audit","type":"finding","severity":"LOW","id":"AUD-045","location":"docs/research/RES-003-gemini-embedding-comparison.md:141,168-183,199-213","current":"RES-003 recommendation section and code examples all use 768d (outputDimensionality: 768, vector(768))","expected":"RES-003 was written before Mark's 3072d directive. Recommendation and code examples are stale. Research document — acceptable as historical record but misleading if referenced without context.","evidence":"Mark directive 0208T1700. RES-003 recommendation 'Use gemini-embedding-001 with 768 dimensions' is superseded by ADR-016 3072d decision."}
{"ts":"0209T0031","from":"audit","type":"done","task":"AUDIT-002","findings_high":4,"findings_medium":5,"findings_low":2,"note":"AUDIT-002: FIX-AUDIT 검증 + 추가 cross-cutting 감사. FIX-AUDIT 미완료 확인 (0 commits on div/arch since EMBED-3072). AUDIT-001의 34개 findings 중: 20 HIGH RESOLVED (EMBED-3072), 2 HIGH OPEN (AUD-021 max tokens, AUD-022 index — FIX-AUDIT), 8 MEDIUM 중 2 RESOLVED (AUD-029 migration logic), 4 LOW 중 1 RESOLVED (AUD-031 index reuse). 신규 11건: 4 HIGH (AUD-035~038: max tokens 재확인, 4-way 인덱스 불일치, RES-001 1536d 메모리 계산 오류, v2-open-items React 잔존), 5 MEDIUM (AUD-039~043: hot_memories SQL 차이, RES-001 layer naming 오류, rateLimitRpm, dimension options, MTEB score 명확화), 2 LOW (AUD-044~045: batch API, RES-003 stale code). 총 미해결: 4 HIGH, 8 MEDIUM, 5 LOW."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-046","location":"packages/infra/src/db/pg-episodic-memory.ts:1-5, pg-semantic-memory.ts:1-8, pg-conceptual-memory.ts:1-7, pg-meta-memory.ts:1, cache/redis-working-memory.ts:1, cache/redis-stream-buffer.ts:1","current":"6 infra files import from packages/core/src/memory/types.js (e.g., import type { EpisodicMemory } from '../../../core/src/memory/types.js')","expected":"CONSTITUTION §9: packages/infra/ may ONLY import from packages/core/src/types/. memory/types.js is NOT within src/types/.","evidence":"CONSTITUTION §9 table: 'packages/infra/ | packages/core/src/types/ only'. These imports use core/src/memory/types.js which is outside the permitted import path. PLAN_SYNC B.7 documents these as cross-package contracts but CONSTITUTION text is strict."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-047","location":"packages/infra/src/llm/anthropic-provider.ts:1-5, llm/google-provider.ts:1-5, mcp/tool-registry.ts:3, db/pg-session-store.ts:1-6","current":"4 infra files import from packages/core/src/orchestrator/types.js (e.g., import type { LlmProvider } from '../../../core/src/orchestrator/types.js')","expected":"CONSTITUTION §9: packages/infra/ may ONLY import from packages/core/src/types/. orchestrator/types.js is NOT within src/types/.","evidence":"CONSTITUTION §9 table: 'packages/infra/ | packages/core/src/types/ only'. PLAN_SYNC B.7 notes LlmProvider was 'moved to core' as DI contract, but placed in orchestrator/types.ts not types/. The PLAN_SYNC acknowledgment doesn't override CONSTITUTION."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-048","location":"packages/infra/src/llm/google-provider.ts:51","current":"let toolCallCounter = 0; — module-level mutable global variable","expected":"No global mutable state (CLAUDE.md preferences: 'no global mutable state', constructor injection for dependencies). toolCallCounter is shared across all GoogleLlmProvider instances and all concurrent requests, causing non-deterministic callId collision.","evidence":"CLAUDE.md coding standards: 'Constructor injection for dependencies (no global mutable state)'. google-provider.ts line 51 declares mutable module-level counter. Concurrent calls from different sessions will share and increment this counter unpredictably."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-049","location":"packages/infra/src/cache/redis-working-memory.ts:38-48 vs docs/adr/003-redis-working-memory.md:120-125","current":"RedisWorkingMemory constructor takes (redis: RedisClient, pg: PgPool) — no CircuitBreaker injection. Uses internal redisState boolean flags instead.","expected":"ADR-003 code example shows constructor with 3 params: (redis, pg, circuitBreaker: CircuitBreaker). ADR-021 mandates explicit circuit breaker state machine. Code uses ad-hoc boolean flag pattern instead of CircuitBreaker from common/circuit-breaker.ts.","evidence":"ADR-003:120-125 constructor(redis, pg, circuitBreaker: CircuitBreaker). Actual code: constructor(redis, pg) with internal { consecutiveFailures, isOpen } object. ADR-021 circuit breaker has proper 3-state FSM (closed/open/half_open). Code only has 2-state (open/not-open) with no half_open probe."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-050","location":"packages/infra/src/db/pg-session-store.ts vs docs/plan/axel-project-plan.md:722-736","current":"PgSessionStore uses sessions table with user_id, channel_history columns. Plan SQL schema (plan:722-736) has NO user_id column and NO channel_history column.","expected":"Plan schema and code should match. Dev-infra sent plan-amendment (PLAN-AMEND-001) for sessions.user_id. SYNC-004 is still IN PROGRESS — plan not yet updated.","evidence":"broadcast.jsonl C43: 'process plan-amendment from dev-infra: sessions table user_id missing in migration-strategy.md'. SYNC-004 stalled 3 cycles (metric-alert). Plan SQL still lacks user_id and channel_history columns."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"HIGH","id":"AUD-051","location":"packages/infra/src/cache/redis-working-memory.ts:52-63","current":"pushTurn() writes to messages table using session_id=$2 with value userId (not actual session_id). SQL: INSERT INTO messages (turn_id, session_id, role, ...) VALUES ($1, $2, ...) with params [turn.turnId, userId, ...]","expected":"session_id column should receive an actual session_id (UUID), not userId. Plan schema (plan:744) defines messages.session_id as TEXT NOT NULL REFERENCES sessions(session_id). Using userId as session_id breaks referential integrity.","evidence":"pg-episodic-memory.ts:47 correctly uses sessionId parameter for messages.session_id. redis-working-memory.ts:53 passes userId as second param which maps to session_id column. This will cause FK violation if sessions table has referential integrity."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-052","location":"packages/infra/src/embedding/index.ts","current":"GeminiEmbeddingService implementation is placed directly in index.ts (182 lines) instead of a dedicated file like gemini-embedding.ts","expected":"Convention in other infra modules: implementation in dedicated file (e.g., anthropic-provider.ts), barrel export in index.ts. The test file is named gemini-embedding.test.ts suggesting the src should be gemini-embedding.ts.","evidence":"All other modules follow pattern: src/db/pg-*.ts + src/db/index.ts (barrel). src/llm/anthropic-provider.ts + src/llm/index.ts (barrel). Embedding breaks this: implementation in index.ts, no barrel separation. Test name 'gemini-embedding.test.ts' mismatches src 'index.ts'."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-053","location":"packages/infra/src/db/pg-episodic-memory.ts:77-88","current":"searchByTopic uses ILIKE '%' || $1 || '%' — parameterized but no pg_trgm index usage. searchByContent (line 91-100) similarly uses ILIKE.","expected":"Plan schema (plan:758) creates gin_trgm_ops index: 'CREATE INDEX idx_messages_content_trgm ON messages USING gin (content gin_trgm_ops)'. ILIKE with '%..%' pattern will NOT use gin_trgm index — requires similarity() or word_similarity() for trigram index utilization. Performance regression on large datasets.","evidence":"PostgreSQL docs: gin_trgm_ops index supports LIKE/ILIKE only for patterns with at least 3 chars and uses index for '%word%' patterns via trigram extraction. However, '% || $1 || %' with dynamic concatenation may not be optimized by planner. pg-semantic-memory.ts correctly uses similarity() function (line 81) for text scoring alongside trigram."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-054","location":"packages/infra/src/mcp/tool-registry.ts:239-244","current":"validatePath uses path.resolve() + startsWith() check. Does NOT resolve symlinks (no fs.realpathSync).","expected":"Security rules (CLAUDE.md): 'Path handling: always validate with path.resolve() + boundary check, block symlink traversal'. Code does resolve() but does NOT block symlinks. A symlink inside basePath could point outside.","evidence":"CLAUDE.md security rules explicitly mention 'block symlink traversal'. tool-registry.ts:239-244 only checks path.resolve().startsWith(basePath) which does not dereference symlinks. fs.realpathSync would resolve symlinks before boundary check. Comment on line 238 says 'Resolves symlinks' but code does not actually call realpath."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-055","location":"packages/infra/src/mcp/tool-registry.ts:179-189","current":"Command allowlist only checks when call.toolName === 'execute_command'. Any other tool can pass command-like args without allowlist check.","expected":"ADR-010 specifies allowlist enforcement for all command execution. Current implementation only guards the specific tool named 'execute_command'. If a tool has a different name but executes commands, it bypasses the allowlist.","evidence":"ADR-010:43 'config.security.commandAllowlist.includes(command)'. Code at tool-registry.ts:179 checks 'call.toolName === \"execute_command\"'. This is a weak enforcement — relies on tool naming convention rather than structural security."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-056","location":"packages/infra/src/llm/anthropic-provider.ts:174-179","current":"handleBlockStop: JSON.parse failure on tool call args silently falls through with empty args {}. No logging or error event.","expected":"Silent failure on tool call JSON parsing could cause tools to execute with missing arguments. Should at minimum log a warning or yield an error event. Tool may produce unexpected results with empty args.","evidence":"anthropic-provider.ts:176 catch block is empty (just passes {} as args). ADR-020 defines error taxonomy including ToolError. Silently swallowing parse errors contradicts ADR-020 principle of explicit error handling."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-057","location":"packages/infra/src/db/pg-semantic-memory.ts:92-123","current":"decay() method fetches ALL memories (SELECT importance FROM memories) into memory, then deletes below threshold. No batch processing, no actual decay calculation.","expected":"ADR-015 defines 8-step decay formula. Plan §3.2 (lines 1010-1085) specifies adaptive decay with recency, access stability, channel diversity factors. PgSemanticMemory.decay() only does threshold-based DELETE — it does not apply the decay formula at all.","evidence":"core/decay/calculator.ts implements the full 8-step formula. But PgSemanticMemory.decay() ignores it — just reads importance and deletes below threshold. The DecayRunConfig only has { threshold: number }, not the full DecayConfig from core/decay/types.ts. The actual decay calculation (updating decayed_importance) is never called from PG adapter."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-058","location":"docs/adr/002-postgresql-single-db.md:23","current":"PostgreSQL 16 + pgvector 0.8","expected":"docker-compose.dev.yml and PLAN_SYNC both specify PostgreSQL 17 + pgvector. ADR-002 still says PostgreSQL 16 + pgvector 0.8.","evidence":"PLAN_SYNC A.1: 'docker-compose.dev.yml | IN_SYNC | PostgreSQL 17 + pgvector + Redis 7'. ADR-002:23 says 'PostgreSQL 16 + pgvector 0.8'. Version mismatch between ADR and actual infrastructure."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"MEDIUM","id":"AUD-059","location":"packages/infra/src/cache/redis-working-memory.ts:117-128","current":"getSummary() returns null on PG fallback path (line 127: return null). Working memory summary is only available from Redis cache.","expected":"ADR-003: 'PG-first write pattern: PG is source of truth, Redis is read cache'. But getSummary has no PG fallback — if Redis is down or summary is not cached, null is returned even if turns exist in PG.","evidence":"ADR-003 degradation table: 'Working Memory read | PG direct read'. getSummary does not query PG at all on the fallback path (line 127). compress() which creates the summary also only writes to Redis (line 147). Summary data has no PG backing — violates ADR-003 principle that Redis data has PG shadow."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-060","location":"packages/infra/src/db/pg-pool.ts:1","current":"import type { ComponentHealth } from '../../../core/src/types/health.js' — uses relative path ../../../core/src/types/","expected":"packages/infra/package.json has @axel/core as workspace dependency. Should use '@axel/core/types' import path (enabled by DEVOPS-004 subpath exports) instead of fragile relative paths.","evidence":"DEVOPS-004 (done C44) added subpath exports: @axel/core/{types,memory,decay,context,persona,orchestrator}. All infra src files still use relative '../../../core/src/...' paths. While functional, this is fragile and doesn't use the intended package boundary mechanism."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-061","location":"packages/infra/src/mcp/tool-registry.ts:79","current":"defineTool returns ToolDefinition & { __handler, __schema } — internal properties with __ prefix leaked into public API","expected":"Internal handler/schema should not be part of the return type. __handler and __schema are implementation details that pollute the ToolDefinition interface.","evidence":"tool-registry.ts:79 return type includes __handler and __schema. These are consumed by ToolRegistry.register() (line 103) but are exposed to all callers of defineTool(). Considered design smell but not a bug — LOW severity."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-062","location":"packages/infra/src/cache/redis-working-memory.ts:130-151","current":"compress() uses try/catch with empty catch blocks. If redis.lrange fails at line 135, function silently returns without compressing.","expected":"Error handling should at minimum log the failure. ADR-003 specifies 'logger.warn' pattern for Redis failures.","evidence":"ADR-003 code examples show explicit logger.warn() calls on Redis failures. Actual code has bare catch blocks (lines 137,150). Non-critical but inconsistent with ADR-003 specification."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-063","location":"packages/infra/src/db/pg-episodic-memory.ts:59","current":"addMessage() increments turn_count via separate UPDATE query. No transaction wrapping the INSERT + UPDATE.","expected":"INSERT message + UPDATE turn_count should be atomic (single transaction). If UPDATE fails after INSERT succeeds, turn_count will be incorrect. Could use a PG trigger or CTE instead.","evidence":"No explicit transaction handling in any PG adapter methods. PG pool wrapper (pg-pool.ts) does not expose transaction API. All multi-statement operations are non-atomic. LOW severity because turn_count is a convenience counter, not critical data."}
{"ts":"0208C45","from":"audit","type":"finding","severity":"LOW","id":"AUD-064","location":"packages/infra/src/common/circuit-breaker.ts:39-41","current":"CircuitBreaker constructor uses Partial<CircuitBreakerConfig> spread. If only some fields provided, defaults fill in.","expected":"ADR-021 specifies failureThreshold=5, cooldownMs=60_000, halfOpenMaxProbes=1. Code defaults (line 19-23) match: failureThreshold=5, cooldownMs=60_000, halfOpenMaxProbes=1. PASS — no issue. But halfOpenMaxProbes is defined but never enforced in the state machine logic.","evidence":"CircuitBreaker.execute() allows any number of calls in half_open state (no probe counter). config.halfOpenMaxProbes is declared but unused. First success in half_open resets to closed regardless of probe count. ADR-021 says 'HALF_OPEN (1 probe)' but code doesn't enforce the limit."}
{"ts":"0208C45","from":"audit","type":"done","task":"AUDIT-003","findings_critical":0,"findings_high":6,"findings_medium":8,"findings_low":5,"note":"AUDIT-003: Phase C code audit (INFRA-001~005, COMMON-CB). 19 findings total. === HIGH (6): AUD-046/047 — CONSTITUTION §9 package boundary violation (infra imports from core/memory/types.js and core/orchestrator/types.js, not from core/src/types/ as §9 requires). AUD-048 — global mutable state in google-provider.ts (toolCallCounter). AUD-049 — ADR-003 circuit breaker spec not followed (ad-hoc boolean vs CircuitBreaker class). AUD-050 — plan-code schema mismatch (sessions table user_id/channel_history missing from plan, SYNC-004 stalled). AUD-051 — userId used as session_id in redis-working-memory pushTurn (FK violation risk). === MEDIUM (8): AUD-052 — naming convention break (embedding impl in index.ts). AUD-053 — ILIKE may not use trigram index. AUD-054 — validatePath doesn't resolve symlinks (security rule violation). AUD-055 — command allowlist weak enforcement. AUD-056 — silent JSON parse failure in anthropic tool calls. AUD-057 — decay() doesn't apply ADR-015 formula. AUD-058 — ADR-002 says PG 16 but infra uses PG 17. AUD-059 — getSummary has no PG fallback (violates ADR-003). === LOW (5): AUD-060 — relative imports instead of @axel/core subpath exports. AUD-061 — __handler/__schema leaked in defineTool return type. AUD-062 — empty catch blocks missing logger.warn per ADR-003. AUD-063 — non-atomic INSERT+UPDATE in addMessage. AUD-064 — halfOpenMaxProbes config declared but never enforced. === TDD: PASS (100% — all 13 non-barrel src files had test-first commits). File size: PASS (max 257 lines, limit 400). No circular deps found. No dead code detected."}
